<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visual Taste Test – Demo</title>
  <style>
    :root{ --bg:#0f1115; --card:#161a22; --muted:#8b93a7; --text:#e8ecf4; --accent:#6ea8fe; }
    body{ background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:24px; }
    .wrap{ max-width:1100px; margin:0 auto; }
    .toolbar{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:16px; }
    .toolbar input{ background:#0b0e13; color:var(--text); border:1px solid #272c36; border-radius:8px; padding:8px 10px; }
    button.cta{ padding:10px 14px; border-radius:8px; border:1px solid #30384a; cursor:pointer; background:#0b0e13; color:var(--text); }
    .row{ display:flex; gap:16px; align-items:stretch; }
    .card{ flex:1; background:var(--card); border:1px solid #232938; border-radius:12px; overflow:hidden; box-shadow:0 2px 12px rgba(0,0,0,.25); }
    .card img{ width:100%; height:320px; object-fit:cover; display:block; background:#0b0e13; }
    .meta{ padding:12px 14px; display:flex; justify-content:space-between; align-items:center; }
    .err{ color:#ff6b6b; margin:8px 0; min-height:1.2em; }
    .small{ font-size:12px; color:var(--muted); }
    .panel{ background:var(--card); border:1px solid #232938; border-radius:12px; padding:16px; margin-top:16px; }
    .bars{ display:grid; grid-template-columns: 200px 1fr; gap:8px 16px; align-items:center; }
    .bar{ height:12px; background:#0b0e13; border:1px solid #2a3142; border-radius:999px; overflow:hidden; }
    .bar > span{ display:block; height:100%; background: linear-gradient(90deg, var(--accent), #9c7bff); width:0%; }
    .pill{ display:inline-block; padding:6px 10px; border:1px solid #2a3142; border-radius:999px; margin:5px 6px 0 0; font-size:12px; color: var(--muted); }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Visual Taste Test – Demo</h1>
  <div class="toolbar">
    <label>User: <input id="uid" size="16" value="demo_user" /></label>
    <button class="cta" onclick="testApi()">Test API</button>
    <button class="cta" onclick="loadPair()">Start / Next</button>
    <button class="cta" onclick="loadProfile()">Get Profile</button>
    <button class="cta" onclick="generateReport()">Generate Report</button>
    <span id="status" class="small"></span>
  </div>

  <div id="error" class="err"></div>

  <div id="pair" class="row" style="display:none"></div>

  <div id="profile" class="panel" style="display:none"></div>

  <div id="report" class="panel" style="display:none"></div>
</div>

<script>
let lastPair = null;

function setError(msg){ document.getElementById('error').textContent = msg || ''; }
function setStatus(msg){ document.getElementById('status').textContent = msg || ''; }

async function testApi(){
  setError('');
  try{
    const h = await fetch('/health'); const hj = await h.json();
    const ii = await fetch('/images'); const ij = await ii.json();
    setStatus(`API OK (attrs=${hj.attrs}, images=${ij.count})`);
  }catch(e){
    setError('API test failed.');
  }
}

function placeholder(text){
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'>
    <rect width='100%' height='100%' fill='#0b0e13'/>
    <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='28' fill='#8b93a7'>${text}</text>
  </svg>`;
  return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
}

async function loadPair(){
  setError('');
  const uid = document.getElementById('uid').value;
  try{
    const res = await fetch(`/next?user_id=${encodeURIComponent(uid)}`);
    if(!res.ok) throw new Error('next failed');
    const data = await res.json();
    lastPair = data;
    const pair = document.getElementById('pair');
    pair.style.display='flex';
    pair.innerHTML = `
      <div class="card">
        <img id="leftImg" src="${data.left_url}" alt="${data.left_name}">
        <div class="meta">
          <div>${data.left_name}</div>
          <button class="cta" onclick="choose('left')">Choose</button>
        </div>
      </div>
      <div class="card">
        <img id="rightImg" src="${data.right_url}" alt="${data.right_name}">
        <div class="meta">
          <div>${data.right_name}</div>
          <button class="cta" onclick="choose('right')">Choose</button>
        </div>
      </div>`;
    const li = document.getElementById('leftImg'); const ri = document.getElementById('rightImg');
    li.onerror = ()=>{ li.src = placeholder(data.left_name); };
    ri.onerror = ()=>{ ri.src = placeholder(data.right_name); };
  }catch(e){
    setError('Could not load an image pair.');
  }
}

async function choose(which){
  setError('');
  if(!lastPair) return;
  const uid = document.getElementById('uid').value;
  try{
    await fetch('/click', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ user_id: uid, left_id: lastPair.left_id, right_id: lastPair.right_id, choice: which })
    });
    await loadPair();
    await loadProfile();
  }catch(e){
    setError('Failed to record click.');
  }
}

function renderBars(container, attrs, w, rel, displayMap){
  const bars = document.createElement('div'); bars.className='bars';
  attrs.forEach((a,i)=>{
    const label = displayMap[a] || a;
    const rowLabel = document.createElement('div');
    rowLabel.innerHTML = `${label}`;
    const bar = document.createElement('div'); bar.className='bar';
    const span = document.createElement('span');
    const pct = Math.min(100, Math.max(0, Math.round((rel && rel[i] ? rel[i] : Math.abs(w[i]))*100)));
    span.style.width = pct + '%';
    bar.appendChild(span);
    bars.appendChild(rowLabel); bars.appendChild(bar);
  });
  container.appendChild(bars);
}

async function loadProfile(){
  setError('');
  const uid = document.getElementById('uid').value;
  try{
    const res = await fetch(`/profile?user_id=${encodeURIComponent(uid)}`);
    if(!res.ok) throw new Error('profile');
    const data = await res.json();
    const res2 = await fetch(`/attrs`); // optional; we know DISPLAY on server
    const display = await res2.json().catch(()=>({display:{}}));
    const div = document.getElementById('profile');
    div.style.display = 'block';
    div.innerHTML = `<h3>Profile for <code>${data.user_id}</code> <span class="small">(n=${data.n_responses})</span></h3>
      <div class="small">Bars show relative importance learned from your clicks.</div>`;
    renderBars(div, data.attrs, data.w, data.relative_importance, (display && display.display) || {});
  }catch(e){
    setError('Could not load profile.');
  }
}

function badge(text){ return `<span class="pill">${text}</span>`; }

async function generateReport(){
  setError('');
  const uid = document.getElementById('uid').value;
  try{
    const pr = await fetch(`/profile_readable?user_id=${encodeURIComponent(uid)}`);
    if(!pr.ok) throw new Error('readable');
    const prof = await pr.json();
    const box = document.getElementById('report');
    box.style.display='block';
    const strong = prof.strong.map(e=>badge(e.label)).join(' ');
    const moderate = prof.moderate.map(e=>badge(e.label)).join(' ');
    const low = prof.low.map(e=>badge(e.label)).join(' ');
    const blurbs = prof.persona_blurbs.map(b=>badge(b)).join(' ');
    box.innerHTML = `
      <h2>${prof.persona_title}</h2>
      <div class="small">Based on your ${prof.n_responses} choices</div>
      <div style="margin:8px 0 12px;">${blurbs}</div>
      <h3>Strong Preferences</h3>
      <div>${strong || badge('Learning… make a few more choices')}</div>
      <h3>Moderate Preferences</h3>
      <div>${moderate || badge('Still calibrating')}</div>
      <h3>Lower Priority</h3>
      <div>${low || badge('Not enough data yet')}</div>
    `;
  }catch(e){
    setError('Could not generate report.');
  }
}

// Auto-test on load
testApi();
</script>
</body>
</html>
